# Архитектура Apache Airflow

Для создания ДАГа внутри айрфлоу - нужно создать python файл и физически разместить его в папку dags или во вложенные в нее папки, то есть папку в которой программа ожидает увидеть наши даги. Апач айрфлоу рекурсивно сканирует папку с ДАГами и пытается добавить их в БД как даг

## Основные компоненты

### Scheduler (Планировщик)

- отслеживает появление ДАГов запуски ДАГов и тасок, а также обновляет статусы у ДАГ ранов и ТАСК инстансов

Если упрощенно, планировщик это бесконечный цикл, который делает следующие шаги:

1. Проверяет наличие ДАГов (классов внутри файлов в папке с дагами), которым требуется новый экземпляр ДАГ рана и создает их
2. Проверяет ДАГ инстансы на задачи требующие выполнения (sheduleable)
3. Проверяет запланированные таск-инстансы и ставит их в очередь на выполнение (передает в экзекьютор), соблюдая ограничения **пулла**

Возможен запуск нескольких планировщиков, в этом случае коллизии работы над одним ДАГом или задачей будут решаться на уровне базы данных

Виды тригеров:  
![alt text](./pictures/triggers_diff.png)

### **Executor (Исполнитель)**

- компонент на стороне Scheduler который определяет, как и где будут выполняться задачи (локально или на удаленных воркерах, последовательно или паралельно)
- **Queue (Очередь)** - компонент между планировщиком и исполнителем позволяющая масштабировать горизонтально айрфлоу. Также позволяет выбрать определенные машины для исполнения задач, т.к. машины могут быть распределены между разными очередями
- **Worker (Работник)** - исполняет таски переданные из планировщика. Причем задачи могут выполняться на той же машине что и планировщик, так и отдельно
- **Папка файлов с DAGs** - папка содержащая код ДАГов читаемая как планировщиком и исполнителем
- **Webserver (Веб-сервер)** - пользовательский веб интерфейс.
- **База данных с метаданными** - реляционная база данных (чаще всего PostgeSQL) используются планировщиком, исполнителем и веб сервером для хранения состояния  
Общая архитектурная схема:  
![alt text](./pictures/arch_schema.png)

## Жизненный цикл задачи и ДАГа

![alt text](./pictures/task_cycle.png)
